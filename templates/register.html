{% extends "base.html" %}

{% block title %}注册 - 网上订餐系统{% endblock %}

{% block content %}
<div id="app_reg">
    <div style="display: flex; justify-content: center; align-items: center; min-height: 80vh;">
        <div class="card" style="padding: 40px; width: 450px;">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">注册账号</h2>
            
            <el-form :model="registerForm" :rules="registerRules" ref="registerFormRef" label-width="0">
                <el-form-item prop="username">
                    <el-input 
                        v-model="registerForm.username" 
                        placeholder="用户名" 
                        prefix-icon="el-icon-user"
                    ></el-input>
                </el-form-item>
                
                <el-form-item prop="password">
                    <el-input 
                        v-model="registerForm.password" 
                        type="password" 
                        placeholder="密码" 
                        prefix-icon="el-icon-lock"
                    ></el-input>
                </el-form-item>
                
                <el-form-item prop="email">
                    <el-input 
                        v-model="registerForm.email" 
                        placeholder="邮箱" 
                        prefix-icon="el-icon-message"
                    ></el-input>
                </el-form-item>
                
                <el-form-item prop="role">
                    <el-select v-model="registerForm.role" placeholder="选择角色" style="width: 100%;" @change="onRoleChange">
                        <el-option label="顾客" value="customer"></el-option>
                        <el-option label="商家" value="merchant"></el-option>
                    </el-select>
                </el-form-item>
                
                <!-- 商家额外信息 -->
                <div v-if="registerForm.role === 'merchant'">
                    <el-form-item prop="store_name">
                        <el-input 
                            v-model="registerForm.store_name" 
                            placeholder="店铺名称" 
                            prefix-icon="el-icon-shop"
                        ></el-input>
                    </el-form-item>
                    
                    <el-form-item prop="phone">
                        <el-input 
                            v-model="registerForm.phone" 
                            placeholder="联系电话" 
                            prefix-icon="el-icon-phone"
                        ></el-input>
                    </el-form-item>
                    
                    <el-form-item>
                        <el-input 
                            v-model="registerForm.description" 
                            type="textarea" 
                            placeholder="店铺描述" 
                            :rows="2"
                        ></el-input>
                    </el-form-item>
                    
                    <el-form-item>
                        <el-input 
                            v-model="registerForm.address" 
                            type="textarea" 
                            placeholder="店铺地址" 
                            :rows="2"
                        ></el-input>
                    </el-form-item>
                </div>
                
                <el-form-item>
                    <el-button 
                        type="primary" 
                        style="width: 100%;" 
                        @click="register"
                        :loading="loading"
                    >
                        注册
                    </el-button>
                </el-form-item>
            </el-form>
            
            <div style="text-align: center; margin-top: 20px;">
                <span style="color: #666;">已有账号？</span>
                <el-button type="text" @click="navigateTo('/login/')" style="color: #3498db;">
                    立即登录
                </el-button>
            </div>
        </div>
    </div>
</div>
<script>
    const {  } = Vue;
    const { } = ElementPlus;

   const app_reg= createApp({
        delimiters: ['[[', ']]'],
        setup() {
            const registerFormRef = ref(null);
            const loading = ref(false);
            
            const registerForm = ref({
                username: '',
                password: '',
                email: '',
                role: '',
                store_name: '',
                phone: '',
                description: '',
                address: ''
            });

            const registerRules = {
                username: [
                    { required: true, message: '请输入用户名', trigger: 'blur' },
                    { min: 3, message: '用户名至少3个字符', trigger: 'blur' }
                ],
                password: [
                    { required: true, message: '请输入密码', trigger: 'blur' },
                    { min: 6, message: '密码至少6个字符', trigger: 'blur' }
                ],
                email: [
                    { required: true, message: '请输入邮箱', trigger: 'blur' },
                    { type: 'email', message: '请输入正确的邮箱地址', trigger: 'blur' }
                ],
                role: [
                    { required: true, message: '请选择角色', trigger: 'change' }
                ],
                store_name: [
                    { required: true, message: '请输入店铺名称', trigger: 'blur' }
                ],
                phone: [
                    { required: true, message: '请输入联系电话', trigger: 'blur' }
                ]
            };

            const onRoleChange = () => {
                if (registerForm.value.role !== 'merchant') {
                    registerForm.value.store_name = '';
                    registerForm.value.phone = '';
                    registerForm.value.description = '';
                    registerForm.value.address = '';
                }
            };

            const register = () => {
                registerFormRef.value.validate(async (valid) => {
                    if (valid) {
                        loading.value = true;
                        try {
                            const response = await fetch('/api/register/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify(registerForm.value)
                            });
                            
                            const data = await response.json();
                            if (data.success) {
                                ElMessage.success('注册成功，请登录');
                                window.location.href = '/login/';
                            } else {
                                ElMessage.error('注册失败: ' + data.error);
                            }
                        } catch (error) {
                            console.error('注册错误:', error);
                            ElMessage.error('注册失败，请检查网络连接');
                        } finally {
                            loading.value = false;
                        }
                    }
                });
            };

            const navigateTo = (path) => {
                window.location.href = path;
            };

            const getCookie = (name) => {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            };

            return {
                registerFormRef,
                loading,
                registerForm,
                registerRules,
                onRoleChange,
                register,
                navigateTo,
                getCookie
            };
        }
    }).use(ElementPlus).mount('#app_reg');
</script>
{% endblock %}