{% extends "base.html" %}

{% block title %}è®¢å•ç®¡ç† - ç½‘ä¸Šè®¢é¤ç³»ç»Ÿ{% endblock %}

{% block extra_css %}
<style>
    .order-list {
        display: flex;
        flex-direction: column;
        gap: 20px;
        margin: 20px 0;
    }
    .order-card {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        padding: 25px;
        border-radius: 15px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    .order-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f1f3f4;
    }
    .order-title {
        font-size: 18px;
        font-weight: 600;
        color: #2c3e50;
    }
    .order-status {
        padding: 6px 16px;
        border-radius: 20px;
        font-size: 14px;
        font-weight: 600;
    }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-confirmed { background: #d1ecf1; color: #0c5460; }
    .status-preparing { background: #d1ecf1; color: #0c5460; }
    .status-ready { background: #d4edda; color: #155724; }
    .status-completed { background: #d4edda; color: #155724; }
    .status-cancelled { background: #f8d7da; color: #721c24; }
    
    .order-details {
        color: #666;
        margin: 8px 0;
    }
    .order-items {
        margin: 15px 0;
        padding: 15px;
        background: rgba(248, 249, 250, 0.5);
        border-radius: 10px;
    }
    .order-item {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
    }
    .order-item:last-child {
        border-bottom: none;
    }
    .order-actions {
        margin-top: 15px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
        color: rgba(255, 255, 255, 0.8);
    }
</style>
{% endblock %}

{% block content %}
<div id="appmerchant">
    <div>
        <h1 style="color: white; margin-bottom: 30px; font-size: 32px; text-shadow: 0 2px 4px rgba(0,0,0,0.3);">
            ğŸ“¦ è®¢å•ç®¡ç†
        </h1>
        
        <div class="order-list">
            <div v-for="order in orders" :key="order.id" class="order-card">
                <div class="order-header">
                    <div>
                        <div class="order-title">è®¢å• #[[ order.order_number || order.id ]]</div>
                        <div style="font-size: 14px; color: #666; margin-top: 5px;">
                            é¡¾å®¢: [[ order.customer_name || 'æœªçŸ¥ç”¨æˆ·' ]]
                        </div>
                    </div>
                    <div :class="'order-status status-' + order.status">
                        [[ order.status_display ]]
                    </div>
                </div>
                
                <div class="order-details">
                    <div><strong>æ€»é‡‘é¢:</strong> Â¥[[ order.total_amount ]]</div>
                    <div><strong>ä¸‹å•æ—¶é—´:</strong> [[ order.created_at ]]</div>
                    <div v-if="order.customer_notes"><strong>é¡¾å®¢å¤‡æ³¨:</strong> [[ order.customer_notes ]]</div>
                </div>
                
                <div class="order-items">
                    <div v-for="item in order.items" :key="item.id" class="order-item">
                        <span>[[ item.dish_name ]] Ã— [[ item.quantity ]]</span>
                        <span>Â¥[[ item.subtotal || (item.price * item.quantity) ]]</span>
                    </div>
                    <div class="order-item" style="font-weight: bold; border-top: 2px solid #dee2e6; margin-top: 8px;">
                        <span>æ€»è®¡</span>
                        <span>Â¥[[ order.total_amount ]]</span>
                    </div>
                </div>
                
                <div class="order-actions">
                    <el-button 
                        v-if="order.status === 'pending'" 
                        type="success" 
                        @click="updateOrderStatus(order.id, 'confirmed')"
                    >
                        âœ… æ¥å•
                    </el-button>
                    <el-button 
                        v-if="order.status === 'pending'" 
                        type="danger" 
                        @click="updateOrderStatus(order.id, 'cancelled')"
                    >
                        âŒ æ‹’ç»
                    </el-button>
                    <el-button 
                        v-if="order.status === 'confirmed'" 
                        type="primary" 
                        @click="updateOrderStatus(order.id, 'preparing')"
                    >
                        ğŸ‘¨â€ğŸ³ å¼€å§‹åˆ¶ä½œ
                    </el-button>
                    <el-button 
                        v-if="order.status === 'preparing'" 
                        type="warning" 
                        @click="updateOrderStatus(order.id, 'ready')"
                    >
                        ğŸ¯ åˆ¶ä½œå®Œæˆ
                    </el-button>
                    <el-button 
                        v-if="order.status === 'ready'" 
                        type="success" 
                        @click="updateOrderStatus(order.id, 'completed')"
                    >
                        âœ… å®Œæˆè®¢å•
                    </el-button>
                    <el-button 
                        v-if="['completed', 'cancelled'].includes(order.status)" 
                        type="info" 
                        disabled
                    >
                        [[ order.status === 'completed' ? 'è®¢å•å·²å®Œæˆ' : 'è®¢å•å·²å–æ¶ˆ' ]]
                    </el-button>
                </div>
            </div>
        </div>
        
        <div v-if="orders.length === 0" class="empty-state">
            <el-empty description="æš‚æ— è®¢å•"></el-empty>
        </div>
    </div>
</div>

<script>
    const {  } = Vue;
    const {  } = ElementPlus;

    const appmerchant = createApp({
        delimiters: ['[[', ']]'],
        setup() {
            const orders = ref([]);

            // ä½¿ç”¨å•†å®¶ä¸“ç”¨APIåŠ è½½è®¢å•
            const loadOrders = async () => {
                try {
                    const response = await fetch('/api/merchant/orders/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({})
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        orders.value = data.orders;
                        console.log('åŠ è½½è®¢å•æˆåŠŸ:', data.orders);
                    } else {
                        ElMessage.error('åŠ è½½è®¢å•å¤±è´¥: ' + data.error);
                    }
                } catch (error) {
                    console.error('åŠ è½½è®¢å•é”™è¯¯:', error);
                    ElMessage.error('åŠ è½½è®¢å•å¤±è´¥');
                }
            };

            const updateOrderStatus = async (orderId, status) => {
                try {
                    const response = await fetch(`/api/orders/${orderId}/status/`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken')
                        },
                        body: JSON.stringify({ status: status })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        ElMessage.success('è®¢å•çŠ¶æ€æ›´æ–°æˆåŠŸ');
                        await loadOrders(); // é‡æ–°åŠ è½½è®¢å•åˆ—è¡¨
                    } else {
                        ElMessage.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥: ' + data.error);
                    }
                } catch (error) {
                    console.error('æ›´æ–°è®¢å•çŠ¶æ€é”™è¯¯:', error);
                    ElMessage.error('æ›´æ–°è®¢å•çŠ¶æ€å¤±è´¥');
                }
            };

            const getCookie = (name) => {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            };

            const getCustomerName = (order) => {
                if (order.customer_name) return order.customer_name;
                if (order.customer && order.customer.user && order.customer.user.username) 
                    return order.customer.user.username;
                return 'æœªçŸ¥ç”¨æˆ·';
            };

            onMounted(() => {
                loadOrders();
                
                // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°è®¢å•
                setInterval(() => {
                    loadOrders();
                }, 30000);
            });

            return {
                orders,
                loadOrders,
                updateOrderStatus,
                getCookie
            };
        }
    });

    appmerchant.use(ElementPlus);
    appmerchant.mount('#appmerchant');
</script>
{% endblock %}