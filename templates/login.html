{% extends "base.html" %}

{% block title %}登录 - 网上订餐系统{% endblock %}

{% block content %}
<div id="appLogin">
    <div style="display: flex; justify-content: center; align-items: center; min-height: 80vh;">
        <div class="card" style="padding: 40px; width: 400px;">
            <h2 style="text-align: center; margin-bottom: 30px; color: #2c3e50;">登录网上订餐系统</h2>
            
            <el-form :model="loginForm" :rules="loginRules" ref="loginFormRef" label-width="0">
                <el-form-item prop="username">
                    <el-input 
                        v-model="loginForm.username" 
                        placeholder="用户名" 
                        size="large"
                    ></el-input>
                </el-form-item>
                
                <el-form-item prop="password">
                    <el-input 
                        v-model="loginForm.password" 
                        type="password" 
                        placeholder="密码" 
                        size="large"
                        @keyup.enter="login"
                    ></el-input>
                </el-form-item>
                
                <el-form-item>
                    <el-button 
                        type="primary" 
                        style="width: 100%;" 
                        size="large" 
                        @click="login"
                        :loading="loading"
                    >
                        登录
                    </el-button>
                </el-form-item>
            </el-form>
            
            <div style="text-align: center; margin-top: 20px;">
                <span style="color: #666;">还没有账号？</span>
                <el-button type="primary" link @click="navigateTo('/register/')" style="color: #3498db;">
                    立即注册
                </el-button>
            </div>

            <!-- 测试账号提示 -->
            <el-alert 
                title="测试账号" 
                type="info" 
                description="商家: merchant1~merchant4 / 顾客: customer1 密码均为: password123" 
                show-icon 
                style="margin-top: 20px;"
                :closable="false"
            ></el-alert>
        </div>
    </div>
</div>

<script>
const {  } = Vue;
const { } = ElementPlus;

    const appLogin = createApp({
        delimiters: ['[[', ']]'],
        setup() {
            const loginFormRef = ref(null);
            const loading = ref(false);
            
            const loginForm = ref({
                username: '',
                password: ''
            });

            const loginRules = {
                username: [
                    { required: true, message: '请输入用户名', trigger: 'blur' }
                ],
                password: [
                    { required: true, message: '请输入密码', trigger: 'blur' }
                ]
            };

            const login = () => {
                loginFormRef.value.validate(async (valid) => {
                    if (valid) {
                        loading.value = true;
                        try {
                            const response = await fetch('/api/login/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCookie('csrftoken')
                                },
                                body: JSON.stringify(loginForm.value)
                            });
                            
                            const data = await response.json();
                            if (data.success) {
                                ElMessage.success('登录成功！');
                                // 根据用户角色跳转到不同页面
                                if (data.user.role === 'customer') {
                                    window.location.href = '/customer/';
                                } else {
                                    window.location.href = '/merchant/';
                                }
                            } else {
                                ElMessage.error('登录失败: ' + data.error);
                            }
                        } catch (error) {
                            console.error('登录错误:', error);
                            ElMessage.error('登录失败，请检查网络连接');
                        } finally {
                            loading.value = false;
                        }
                    }
                });
            };

            const navigateTo = (path) => {
                window.location.href = path;
            };

            const getCookie = (name) => {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            };

            return {
                loginFormRef,
                loading,
                loginForm,
                loginRules,
                login,
                navigateTo,
                getCookie
            };
        }
    }).use(ElementPlus).mount('#appLogin');
</script>
{% endblock %}